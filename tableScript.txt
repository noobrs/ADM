DROP TABLE ReservationDetail;
DROP TABLE LoanDetail;
DROP TABLE Fine;
DROP TABLE Reservation;
DROP TABLE Loan;
DROP TABLE Booking;
DROP TABLE MemberRenewal;
DROP TABLE Invoice;
DROP TABLE Facility;
DROP TABLE Book;
DROP TABLE Member;

-- Member Table
CREATE TABLE Member (
    MemberID 		CHAR (10)	NOT NULL,
    FirstName 		VARCHAR (50)	NOT NULL,
    LastName 		VARCHAR (50)	NOT NULL,
    DOB 		DATE		NOT NULL,
    PhoneNumber 	VARCHAR (15)	NOT NULL,
    Gender 		CHAR(1)		NOT NULL,
    Email 		VARCHAR (100)	NOT NULL,
    StartDate		DATE		NOT NULL,
    EndDate		DATE		NOT NULL,
    PRIMARY KEY (MemberID),
    CONSTRAINT member_gender CHECK (UPPER(Gender) in ('M', 'F')),
    CONSTRAINT member_email CHECK (REGEXP_LIKE(Email,'^[a-zA-Z]\w+@(\S+)$'))
);

-- Book Table
CREATE TABLE Book (
    BookID 		CHAR (10)	NOT NULL,
    Title 		VARCHAR (255)	NOT NULL,
    Author 		VARCHAR (255)	NOT NULL,
    Isbn 		CHAR (13)	NOT NULL,
    Price 		NUMBER (6,2)	NOT NULL,
    PublicationYear 	NUMBER (4)	NOT NULL,
    Genre 		VARCHAR (50)	NOT NULL,
    TotalCopies 	NUMBER		NOT NULL,
    AvailableCopies 	NUMBER		NOT NULL,
    BorrowedCount 	NUMBER		NOT NULL,
    PRIMARY KEY (BookID)
);

-- Facility Table
CREATE TABLE Facility (
    FacilityID 		CHAR (10) 	NOT NULL,
    Name 		VARCHAR (100) 	NOT NULL,
    Description 	VARCHAR (255) 	NOT NULL,
    Capacity 		NUMBER (3) 	NOT NULL,
    FacilityStatus 	VARCHAR (50) 	NOT NULL,
    PRIMARY KEY (FacilityID),
    CONSTRAINT fac_status CHECK (UPPER(FacilityStatus) IN ('Available', 'Occupied', 'Under Maintenance'))
);

-- Invoice Table
CREATE TABLE Invoice (
    InvoiceID 		CHAR (10) 	NOT NULL,
    InvoiceDateTime 	TIMESTAMP 	NOT NULL,
    PaymentDateTime 	TIMESTAMP 	NOT NULL,
    PaymentMethod 	VARCHAR(50) 	NOT NULL,
    TotalAmount 	NUMBER (8,2) 	NOT NULL,
    MemberID 		CHAR (10) 	NOT NULL,
    PRIMARY KEY (InvoiceID),
    FOREIGN KEY (MemberID) REFERENCES Member(MemberID)
);

-- MemberRenewal Table
CREATE TABLE MemberRenewal (
    MemberRenewalID 	CHAR (10) 	NOT NULL,
    MemberRenewalType 	VARCHAR (50) 	NOT NULL,
    RenewalFee 		NUMBER (5, 2) 	NOT NULL,
    RenewalDateTime	TIMESTAMP 	NOT NULL,
    InvoiceID 		CHAR (10) 	NOT NULL,
    MemberID 		CHAR (10) 	NOT NULL,
    PRIMARY KEY (MemberRenewalID),
    FOREIGN KEY (InvoiceID) REFERENCES Invoice(InvoiceID),
    FOREIGN KEY (MemberID) REFERENCES Member(MemberID)
);

-- Booking Table
CREATE TABLE Booking (
    BookingID 		CHAR (10) 	NOT NULL,
    BookingDateTime 	TIMESTAMP 	NOT NULL,
    StartTime 		TIMESTAMP 	NOT NULL,
    EndTime 		TIMESTAMP 	NOT NULL,
    BookingStatus 	VARCHAR (50)  	NOT NULL,
    MemberID 		CHAR (10) 	NOT NULL,
    FacilityID 		CHAR (10) 	NOT NULL,
    PRIMARY KEY (BookingID),
    FOREIGN KEY (MemberID) REFERENCES Member(MemberID),
    FOREIGN KEY (FacilityID) REFERENCES Facility(FacilityID),
    CONSTRAINT bookingStt CHECK (UPPER(BookingStatus) IN ('Pending', 'Confirmed', 'Cancelled'))
);

-- Loan Table
CREATE TABLE Loan (
    LoanID 		CHAR (10) 	NOT NULL,
    LoanDate 		DATE 		NOT NULL,
    DueDate 		DATE 		NOT NULL,
    MemberID 		CHAR (10)	NOT NULL,
    PRIMARY KEY (LoanID),
    FOREIGN KEY (MemberID) REFERENCES Member(MemberID)
);

-- Reservation Table
CREATE TABLE Reservation (
    ReservationID 	CHAR (10) 	NOT NULL,
    ReservationDateTime TIMESTAMP 	NOT NULL,
    ExpirationDate	DATE 		NOT NULL,
    ReservationStatus 	VARCHAR (50) 	NOT NULL ,
    Remark		VARCHAR (100) ,
    MemberID 		CHAR (10) 	NOT NULL,
    PRIMARY KEY (ReservationID),
    FOREIGN KEY (MemberID) REFERENCES Member(MemberID),
    CONSTRAINT resStatus CHECK (UPPER(ReservationStatus) IN ('PENDING', 'CONFIRMED', 'CANCELLED'))
);

-- Fine Table
CREATE TABLE Fine (
    FineID 		CHAR (10) 	NOT NULL,
    FineAmount 		NUMBER (6,2) 	NOT NULL,
    FineStatus 		VARCHAR (50) 	NOT NULL,
    IssueDateTime 	TIMESTAMP 	NOT NULL,
    AdditionalFee 	NUMBER (6,2),
    Remark 		VARCHAR (100),
    InvoiceID 		CHAR (10),
    PRIMARY KEY (FineID),
    FOREIGN KEY (InvoiceID) REFERENCES Invoice(InvoiceID),
    CONSTRAINT fineStt CHECK (UPPER(FineStatus) IN ('UNPAID', 'PAID'))
);

-- LoanDetail Table
CREATE TABLE LoanDetail (
    LoanID 		CHAR (10) 	NOT NULL,
    BookID 		CHAR (10) 	NOT NULL,
    ReturnDate 		DATE 		NOT NULL,
    LoanExtension 	NUMBER (1) 	NOT NULL,
    ExtendedDueDate 	DATE 		NOT NULL,
    Status 		VARCHAR (50) 	NOT NULL,
    FineID		CHAR (10) 	NOT NULL,
    PRIMARY KEY (LoanID, BookID),
    FOREIGN KEY (BookID) REFERENCES Book(BookID),
    FOREIGN KEY (LoanID) REFERENCES Loan(LoanID),
    FOREIGN KEY (FineID) REFERENCES Fine(FineID),
    CONSTRAINT loanExt CHECK (LoanExtension IN (0,1)),
    CONSTRAINT LDStatus CHECK (UPPER(Status) IN ('BORROWED', 'RETURNED', 'EXTENDED'))
);

-- ReservationDetail Table (Bridge Entity)
CREATE TABLE ReservationDetail (
    ReservationID 	CHAR (10) 	NOT NULL,
    BookID 		CHAR (10) 	NOT NULL,
    AvailableDateTime	TIMESTAMP,
    PickupDateTime	TIMESTAMP	NOT NULL,
    PRIMARY KEY (ReservationID, BookID),
    FOREIGN KEY (BookID) REFERENCES Book(BookID),
    FOREIGN KEY (ReservationID) REFERENCES Reservation(ReservationID)
);


COMMIT;

