SET SERVEROUTPUT ON;
SET LINESIZE 200;
SET PAGESIZE 120;

CREATE TABLE ReservationLimitLog (
    MemberID           CHAR(10),
    ReservationID      CHAR(10),
    AttemptedDate      DATE,
    ActiveReservationCount NUMBER,
    Message            VARCHAR2(255)
);


CREATE OR REPLACE TRIGGER trg_check_active_reservations
BEFORE INSERT ON Reservation
FOR EACH ROW
DECLARE
    v_active_count NUMBER;
    v_error_message VARCHAR2(255);
BEGIN
    SELECT COUNT(*)
    INTO v_active_count
    FROM Reservation
    WHERE MemberID = :NEW.MemberID
      AND UPPER(ReservationStatus) IN ('PENDING', 'READY');

    -- block the insert and log it
    IF v_active_count >= 3 THEN
        -- Prepare error message
        v_error_message := 'Member ' || :NEW.MemberID || ' already has ' || v_active_count || ' active reservations. Max is 3.';

        DECLARE
            PRAGMA AUTONOMOUS_TRANSACTION;
        BEGIN
            INSERT INTO ReservationLimitLog (
                MemberID, ReservationID, AttemptedDate, ActiveReservationCount, Message
            ) VALUES (
                :NEW.MemberID, :NEW.ReservationID, SYSDATE, v_active_count, v_error_message
            );
            COMMIT;
        END;

        DBMS_OUTPUT.PUT_LINE('--- Reservation Limit Exceeded ---');
        DBMS_OUTPUT.PUT_LINE('Member ID         : ' || :NEW.MemberID);
        DBMS_OUTPUT.PUT_LINE('Attempted Date    : ' || TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS'));
        DBMS_OUTPUT.PUT_LINE('Current Active    : ' || v_active_count);
        DBMS_OUTPUT.PUT_LINE('Blocked Reservation ID : ' || :NEW.ReservationID);

        -- Raise error to stop insert
        RAISE_APPLICATION_ERROR(-20000, v_error_message);
    END IF;
END;
/


-- First, insert 3 reservations (all in 'PENDING' status for the same member)
INSERT INTO Reservation VALUES ('RES0000101', SYSDATE, 'PENDING', NULL, NULL, 'MEM0000001');
INSERT INTO Reservation VALUES ('RES0000102', SYSDATE + 1, 'PENDING', NULL, NULL, 'MEM0000001');
INSERT INTO Reservation VALUES ('RES0000103', SYSDATE + 2, 'PENDING', NULL, NULL, 'MEM0000001');

-- Now, try to insert a 4th reservation for the same member (This should raise the error)
INSERT INTO Reservation VALUES ('RES0000104', SYSDATE + 3, 'PENDING', NULL, NULL, 'MEM0000001');

select * from reservationlimitlog;
